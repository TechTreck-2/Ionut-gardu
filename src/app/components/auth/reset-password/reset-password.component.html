<!-- Reset Password Component Template -->
<div class="reset-password-container">
  <!-- Loading Screen -->
  <div *ngIf="isLoading" class="loading-overlay" role="status" aria-live="polite" aria-label="Processing password reset">
    <mat-spinner diameter="60" class="loading-spinner" aria-label="Loading"></mat-spinner>
    <p class="loading-text">Resetting your password...</p>
  </div>

  <!-- Success State -->
  <div *ngIf="passwordResetSuccess" class="success-container" role="main" aria-live="polite">
    <mat-card class="reset-card success-card" aria-labelledby="success-title">
      <mat-card-header class="card-header success-header">
        <div mat-card-avatar class="success-avatar" aria-hidden="true">
          <mat-icon class="success-icon">check_circle</mat-icon>
        </div>
        <mat-card-title id="success-title" class="card-title">
          Password Reset Successful!
        </mat-card-title>
      </mat-card-header>

      <mat-card-content class="card-content">
        <p class="success-message">
          Your password has been successfully reset. You can now log in with your new password.
        </p>
        <p class="redirect-message">
          You will be automatically redirected to the login page in a few seconds...
        </p>
      </mat-card-content>

      <mat-card-actions class="card-actions" align="end">
        <a
          mat-raised-button 
          color="primary"
          routerLink="/login"
          class="success-button"
          aria-label="Go to login page">
          Go to Login
        </a>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Main Reset Password Form -->
  <div *ngIf="!passwordResetSuccess && !isLoading" class="form-container" role="main">
    <mat-card class="reset-card" aria-labelledby="reset-title">
      <!-- Card Header -->
      <mat-card-header class="card-header">
        
        <mat-card-title id="reset-title" class="card-title">
          Reset Your Password
        </mat-card-title>
        <mat-card-subtitle class="card-subtitle">
          Enter your new password below
        </mat-card-subtitle>
      </mat-card-header>

      <!-- Card Content -->
      <mat-card-content class="card-content">
        <!-- General Error Message -->
        <div 
          *ngIf="error && !error.field" 
          class="error-message general-error" 
          role="alert" 
          aria-live="assertive">
          <mat-icon class="error-icon" aria-hidden="true">error</mat-icon>
          <span>{{ error.message }}</span>
        </div>

        <!-- Reset Password Form -->
        <form 
          [formGroup]="resetPasswordForm" 
          (ngSubmit)="onSubmit()" 
          class="reset-form"
          novalidate
          autocomplete="on">

          <!-- Password Field -->
          <mat-form-field 
            class="form-field" 
            appearance="outline"
            [class.has-error]="passwordControl.invalid && passwordControl.touched">
            <mat-label>New Password</mat-label>
            <input 
              matInput
              formControlName="password"
              [type]="hidePassword ? 'password' : 'text'"
              placeholder="Enter your new password"
              autocomplete="new-password"
              [attr.aria-describedby]="getAriaDescribedBy('password')"
              [attr.aria-invalid]="passwordControl.invalid && passwordControl.touched"
              class="password-input">
            <mat-icon 
              matSuffix 
              (click)="togglePasswordVisibility()" 
              class="visibility-toggle"
              [attr.aria-label]="hidePassword ? 'Show password' : 'Hide password'"
              tabindex="0"
              role="button"
              (keydown.enter)="togglePasswordVisibility()"
              (keydown.space)="togglePasswordVisibility()">
              {{ hidePassword ? 'visibility' : 'visibility_off' }}
            </mat-icon>
            <mat-error 
              *ngIf="passwordControl.invalid && passwordControl.touched"
              [id]="passwordErrorId"
              class="field-error"
              role="alert">
              {{ getPasswordErrorMessage() }}
            </mat-error>
          </mat-form-field>

          <!-- Password Confirmation Field -->
          <mat-form-field 
            class="form-field" 
            appearance="outline"
            [class.has-error]="passwordConfirmationControl.invalid && passwordConfirmationControl.touched || resetPasswordForm.hasError('passwordMismatch')">
            <mat-label>Confirm New Password</mat-label>
            <input 
              matInput
              formControlName="passwordConfirmation"
              [type]="hidePasswordConfirmation ? 'password' : 'text'"
              placeholder="Confirm your new password"
              autocomplete="new-password"
              [attr.aria-describedby]="getAriaDescribedBy('passwordConfirmation')"
              [attr.aria-invalid]="passwordConfirmationControl.invalid && passwordConfirmationControl.touched || resetPasswordForm.hasError('passwordMismatch')"
              class="password-input">
            <mat-icon 
              matSuffix 
              (click)="togglePasswordConfirmationVisibility()" 
              class="visibility-toggle"
              [attr.aria-label]="hidePasswordConfirmation ? 'Show password' : 'Hide password'"
              tabindex="0"
              role="button"
              (keydown.enter)="togglePasswordConfirmationVisibility()"
              (keydown.space)="togglePasswordConfirmationVisibility()">
              {{ hidePasswordConfirmation ? 'visibility' : 'visibility_off' }}
            </mat-icon>
            <mat-error 
              *ngIf="passwordConfirmationControl.invalid && passwordConfirmationControl.touched || resetPasswordForm.hasError('passwordMismatch')"
              [id]="passwordConfirmationErrorId"
              class="field-error"
              role="alert">
              {{ getPasswordConfirmationErrorMessage() }}
            </mat-error>
          </mat-form-field>
        </form>
      </mat-card-content>

      <!-- Card Actions -->
      <mat-card-actions class="card-actions" align="end">
        <a
          mat-button
          routerLink="/login"
          class="secondary-button"
          [attr.aria-label]="'Go back to login page'"
          tabindex="0">
          <mat-icon class="button-icon">arrow_back</mat-icon>
          Back to Login
        </a>
        <button
          mat-raised-button
          color="primary"
          type="submit"
          (click)="onSubmit()"
          [disabled]="resetPasswordForm.invalid || isLoading"
          class="submit-button"
          [attr.aria-label]="'Reset password'"
          [attr.aria-describedby]="error ? 'general-error' : null">
          <mat-icon class="button-icon">lock_reset</mat-icon>
          <span *ngIf="!isLoading">Reset Password</span>
          <span *ngIf="isLoading">Resetting...</span>
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>

<!-- Screen Reader Only Instructions -->
<div class="sr-only" role="region" aria-label="Instructions for screen readers">
  <p>This page allows you to reset your password using the reset code sent to your email. Fill in the form with your new password and confirmation, then click the Reset Password button.</p>
</div>
