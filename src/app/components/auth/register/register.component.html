<div class="register-container" role="main">
  <mat-card class="register-card" [attr.aria-busy]="isLoading">
    <mat-card-header>
      <mat-card-title class="register-title">
        Create Account
      </mat-card-title>
      <mat-card-subtitle>Join our platform today</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <form 
        [formGroup]="registerForm" 
        (ngSubmit)="onSubmit()" 
        novalidate
        autocomplete="on"
        role="form"
        aria-label="Registration form"
      >
        <!-- Username Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Username</mat-label>
          <input 
            matInput 
            type="text" 
            formControlName="username" 
            autocomplete="username"
            spellcheck="false"
            [attr.aria-describedby]="getAriaDescribedBy('username')"
            [attr.aria-invalid]="usernameControl.invalid && usernameControl.touched"
            placeholder="Choose a username"
            required
          >
          
          <mat-error 
            *ngIf="usernameControl.invalid && usernameControl.touched"
            [id]="usernameErrorId"
            role="alert"
            aria-live="polite"
          >
            {{ getUsernameErrorMessage() }}
          </mat-error>
        </mat-form-field>

        <!-- Email Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email Address</mat-label>
          <input 
            matInput 
            type="email" 
            formControlName="email" 
            autocomplete="email"
            spellcheck="false"
            [attr.aria-describedby]="getAriaDescribedBy('email')"
            [attr.aria-invalid]="emailControl.invalid && emailControl.touched"
            placeholder="Enter your email address"
            required
          >
          
          <mat-error 
            *ngIf="emailControl.invalid && emailControl.touched"
            [id]="emailErrorId"
            role="alert"
            aria-live="polite"
          >
            {{ getEmailErrorMessage() }}
          </mat-error>
        </mat-form-field>

        <!-- Password Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input 
            matInput 
            [type]="hidePassword ? 'password' : 'text'"
            formControlName="password"
            autocomplete="new-password"
            [attr.aria-describedby]="getAriaDescribedBy('password')"
            [attr.aria-invalid]="passwordControl.invalid && passwordControl.touched"
            placeholder="Create a strong password"
            required
          >
          
          <button 
            matSuffix 
            mat-icon-button 
            type="button"
            (click)="togglePasswordVisibility()"
            [attr.aria-label]="hidePassword ? 'Show password' : 'Hide password'"
            [attr.aria-pressed]="!hidePassword"
            tabindex="-1"
          >
            <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          
          <mat-error 
            *ngIf="passwordControl.invalid && passwordControl.touched"
            [id]="passwordErrorId"
            role="alert"
            aria-live="polite"
          >
            {{ getPasswordErrorMessage() }}
          </mat-error>
        </mat-form-field>

        <!-- Password Strength Indicator -->
        <div 
          class="password-strength" 
          *ngIf="passwordControl.value"
          role="status"
          aria-live="polite"
        >
          <div class="strength-meter">
            <div class="strength-bar">
              <div 
                class="strength-fill" 
                [style.width.%]="(passwordStrength.score / 5) * 100"
                [attr.data-strength]="passwordStrength.color"
              ></div>
            </div>
            <span class="strength-text" [attr.data-strength]="passwordStrength.color">
              {{ passwordStrength.score < 2 ? 'Weak' : passwordStrength.score < 4 ? 'Medium' : 'Strong' }}
            </span>
          </div>
          <ul class="strength-feedback" *ngIf="passwordStrength.feedback.length > 0">
            <li *ngFor="let tip of passwordStrength.feedback">{{ tip }}</li>
          </ul>
        </div>

        <!-- Confirm Password Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirm Password</mat-label>
          <input 
            matInput 
            [type]="hideConfirmPassword ? 'password' : 'text'"
            formControlName="confirmPassword"
            autocomplete="new-password"
            [attr.aria-describedby]="getAriaDescribedBy('confirmPassword')"
            [attr.aria-invalid]="confirmPasswordControl.invalid && confirmPasswordControl.touched"
            placeholder="Confirm your password"
            required
          >
          
          <button 
            matSuffix 
            mat-icon-button 
            type="button"
            (click)="toggleConfirmPasswordVisibility()"
            [attr.aria-label]="hideConfirmPassword ? 'Show password' : 'Hide password'"
            [attr.aria-pressed]="!hideConfirmPassword"
            tabindex="-1"
          >
            <mat-icon>{{ hideConfirmPassword ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          
          <mat-error 
            *ngIf="(confirmPasswordControl.invalid && confirmPasswordControl.touched) || registerForm.hasError('passwordMismatch')"
            [id]="confirmPasswordErrorId"
            role="alert"
            aria-live="polite"
          >
            {{ getConfirmPasswordErrorMessage() }}
          </mat-error>
        </mat-form-field>

        <!-- Terms and Conditions -->
        <div class="terms-section">
          <mat-checkbox 
            formControlName="acceptTerms"
            color="primary"
            class="terms-checkbox"
            [attr.aria-describedby]="acceptTermsControl.invalid ? 'terms-error' : ''"
          >
            I agree to the 
            <a href="/terms" target="_blank" rel="noopener">Terms of Service</a> 
            and 
            <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a>
          </mat-checkbox>
          
          <mat-error 
            *ngIf="acceptTermsControl.invalid && acceptTermsControl.touched"
            id="terms-error"
            role="alert"
            aria-live="polite"
            class="terms-error"
          >
            You must accept the terms and conditions to register
          </mat-error>
        </div>

        <!-- Global Error Message -->
        <div 
          class="error-alert" 
          *ngIf="error" 
          role="alert" 
          aria-live="assertive"
          [attr.data-field]="error.field"
        >
          <mat-icon>error</mat-icon>
          <span>{{ error.message }}</span>
        </div>

        <!-- Submit Button -->
        <button 
          mat-raised-button 
          color="primary" 
          type="submit" 
          class="register-button full-width"
          [disabled]="!registerForm.valid || isLoading"
          [attr.aria-busy]="isLoading"
        >
          <span *ngIf="!isLoading">Create Account</span>
          <span *ngIf="isLoading" class="loading-content">
            <mat-spinner diameter="20" aria-label="Creating account..."></mat-spinner>
            Creating Account...
          </span>
        </button>
      </form>
      
      <!-- Login Link -->
      <div class="login-link" role="navigation">
        <span>Already have an account? </span>
        <a 
          routerLink="/login" 
          class="link-primary"
          [attr.tabindex]="isLoading ? '-1' : '0'"
        >
          Sign in here
        </a>
      </div>
    </mat-card-content>
  </mat-card>
</div>